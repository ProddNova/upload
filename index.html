<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Lost Trace Unit ‚Äì Mappa spot abbandonati</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Mappa interattiva per esploratori urbani - Gestione spot abbandonati LTU">
  <meta name="theme-color" content="#020617">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Rotate CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.touchrotateloading/leaflet.touchrotateloading.css" />
  
  <!-- App Styles -->
  <style>
    /* ==================== VARIABLES & RESET ==================== */
    :root {
      --bg-main: #020617;
      --bg-elevated: #020617;
      --bg-panel: rgba(15, 23, 42, 0.98);
      --bg-soft: #0b1120;
      --accent-main: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.15);
      --text-main: #e5e7eb;
      --text-dim: #9ca3af;
      --border-soft: rgba(148, 163, 184, 0.4);
      --shadow-strong: 0 20px 50px rgba(15, 23, 42, 0.95);
      --radius-card: 16px;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: radial-gradient(circle at top, #02081a 0, #020617 45%, #000 100%);
      color: var(--text-main);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    /* ==================== LOADING SCREEN ==================== */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-logo {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      position: relative;
    }

    .loading-logo::before {
      content: 'üó∫Ô∏è';
      font-size: 60px;
      filter: drop-shadow(0 0 10px rgba(37, 99, 235, 0.5));
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(37, 99, 235, 0.3);
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: var(--text-dim);
      text-align: center;
      max-width: 300px;
      line-height: 1.5;
    }

    /* ==================== MAP CONTAINER ==================== */
    #map {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
      cursor: crosshair;
    }

    /* ==================== CROSSHAIR & PINS ==================== */
    #crosshair {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      pointer-events: none;
      z-index: 8;
      display: none;
    }

    #crosshair::before,
    #crosshair::after {
      content: '';
      position: absolute;
      background: var(--error);
      border: 1px solid #000;
    }

    #crosshair::before {
      width: 16px;
      height: 2px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    #crosshair::after {
      width: 2px;
      height: 16px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    #temporaryPin {
      position: absolute;
      width: 32px;
      height: 32px;
      background: var(--error);
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 10;
      pointer-events: none;
      display: none;
      transform: translate(-50%, -50%);
    }

    #temporaryPin::after {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* ==================== DOCK CONTAINERS ==================== */
    #leftDock {
      position: fixed;
      left: 10px;
      top: 10px;
      z-index: 30;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #rightDock {
      position: fixed;
      right: 10px;
      top: 10px;
      z-index: 30;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.3s ease;
    }

    #rightDock.collapsed .dock-btn:not(#dockToggleBtn) {
      display: none;
    }

    #rightDock.collapsed #legendContainer {
      display: none;
    }

    .dock-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--border-soft);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
      color: var(--text-main);
      box-shadow: 0 12px 25px rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .dock-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.95);
    }

    .dock-btn:active {
      transform: translateY(0) scale(0.95);
    }

    .dock-btn.active {
      border-color: var(--accent-main);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
    }

    .dock-btn .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--error);
      color: white;
      font-size: 10px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--bg-panel);
    }

    /* ==================== MAP NAVIGATION ==================== */
    #mapNavToggle {
      position: fixed;
      bottom: 70px;
      right: 10px;
      z-index: 30;
    }

    #mapNavigation {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 30;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    #mapNavigation.show {
      display: flex;
    }

    #mapNavInfo {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-soft);
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(10px);
    }

    #mapNavControls {
      display: flex;
      gap: 12px;
    }

    .nav-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    .nav-btn:hover {
      background: rgba(37, 99, 235, 0.8);
      transform: scale(1.1);
    }

    /* ==================== LEGEND ==================== */
    #legendContainer {
      width: 44px;
      height: auto;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 12px 25px rgba(15, 23, 42, 0.9);
      padding: 12px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
    }

    .legend-row {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 0 10px;
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-block;
      border: 2px solid var(--bg-main);
      margin: 0;
    }

    .legend-number {
      font-size: 11px;
      color: var(--text-dim);
      margin-left: 6px;
      min-width: 10px;
      font-weight: 600;
    }

    /* ==================== OVERLAY PANELS ==================== */
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 80;
      padding: 20px;
    }

    .overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .overlay-card {
      position: relative;
      z-index: 81;
      background: var(--bg-panel);
      border-radius: var(--radius-card);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-strong);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .overlay-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(31, 41, 55, 1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: rgba(15, 23, 42, 0.8);
    }

    .overlay-header-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .overlay-header-title strong {
      font-size: 16px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-main);
    }

    .overlay-header-title small {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.4;
    }

    .overlay-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    /* ==================== FORM ELEMENTS ==================== */
    .form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    .form-row label {
      font-size: 13px;
      color: var(--text-dim);
      font-weight: 500;
    }

    .input, .textarea, .select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 1);
      background: rgba(15, 23, 42, 0.95);
      padding: 12px 16px;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    .input:focus, .textarea:focus, .select:focus {
      border-color: var(--accent-main);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    .textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
    }

    .cols {
      display: flex;
      gap: 12px;
    }

    .cols .form-row {
      flex: 1;
    }

    /* ==================== BUTTONS ==================== */
    .btn {
      border-radius: 999px;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-main), #3b82f6);
      color: white;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.9);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.95);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-dim);
      border: 1px solid rgba(55, 65, 81, 1);
    }

    .btn-secondary:hover {
      border-color: var(--accent-main);
      color: var(--text-main);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--error), #f87171);
      color: white;
      box-shadow: 0 10px 24px rgba(239, 68, 68, 0.9);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #34d399);
      color: white;
      box-shadow: 0 10px 24px rgba(16, 185, 129, 0.9);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    /* ==================== LIST PANEL ==================== */
    .spot-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(31, 41, 55, 1);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .spot-row:hover {
      border-color: rgba(59, 130, 246, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .spot-row.highlighted {
      border-color: #fbbf24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.8), 0 8px 24px rgba(251, 191, 36, 0.3);
      background: radial-gradient(circle at top left, rgba(30, 41, 59, 1), rgba(15, 23, 42, 0.96));
    }

    .spot-emoji {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(17, 24, 39, 1), rgba(15, 23, 42, 1));
      font-size: 20px;
      flex-shrink: 0;
    }

    .spot-main {
      flex: 1;
      min-width: 0;
    }

    .spot-main-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .spot-main-title strong {
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-main);
    }

    .spot-vote-pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid rgba(55, 65, 81, 1);
      background: rgba(15, 23, 42, 1);
      color: var(--text-dim);
      flex-shrink: 0;
      min-width: 32px;
      text-align: center;
    }

    .spot-desc {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
      max-height: 3em;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 8px;
    }

    .spot-meta {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.95);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .spot-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .spot-row:hover .spot-actions {
      opacity: 1;
    }

    .spot-action-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 1);
      color: var(--text-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .spot-action-btn:hover {
      background: var(--accent-main);
      color: white;
      border-color: var(--accent-main);
    }

    /* ==================== TOAST NOTIFICATION ==================== */
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .toast {
      background: var(--bg-panel);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow-strong);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .toast-message {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .toast-close:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--error);
    }

    .toast-warning {
      border-left: 4px solid var(--warning);
    }

    .toast-info {
      border-left: 4px solid var(--info);
    }

    /* ==================== FILTERS PANEL ==================== */
    .filters-panel {
      background: var(--bg-panel);
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      margin-bottom: 16px;
    }

    .filter-group-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-chip {
      padding: 8px 16px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(55, 65, 81, 1);
      border-radius: 999px;
      font-size: 13px;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-chip:hover {
      border-color: var(--accent-main);
      color: var(--text-main);
    }

    .filter-chip.active {
      background: var(--accent-main);
      color: white;
      border-color: var(--accent-main);
    }

    /* ==================== LEAFLET CUSTOM STYLES ==================== */
    .leaflet-popup-content-wrapper {
      background: var(--bg-panel) !important;
      border-radius: 16px !important;
      box-shadow: var(--shadow-strong) !important;
      border: 1px solid var(--border-soft) !important;
      padding: 0 !important;
    }

    .leaflet-popup-content {
      margin: 0 !important;
      padding: 24px !important;
      min-width: 320px !important;
      font-family: inherit !important;
    }

    .leaflet-popup-tip {
      background: var(--bg-panel) !important;
      border: 1px solid var(--border-soft) !important;
      box-shadow: var(--shadow-strong) !important;
    }

    .leaflet-popup-close-button {
      color: var(--text-dim) !important;
      font-size: 20px !important;
      top: 12px !important;
      right: 12px !important;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .leaflet-popup-close-button:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error) !important;
    }

    .ltu-custom-pin {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      width: 32px !important;
      height: 44px !important;
    }

    /* ==================== SYNC STATUS ==================== */
    #syncStatus {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 35;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-soft);
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: all 0.3s ease;
    }

    #syncStatus.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-5px);
    }

    #syncStatus.syncing {
      color: var(--info);
    }

    #syncStatus.success {
      color: var(--success);
    }

    #syncStatus.error {
      color: var(--error);
    }

    /* ==================== CONFIRM MODAL ==================== */
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .confirm-modal-content {
      background: var(--bg-panel);
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-strong);
      animation: slideUp 0.3s ease;
    }

    .confirm-modal-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-main);
    }

    .confirm-modal-message {
      font-size: 14px;
      color: var(--text-dim);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .confirm-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* ==================== SEARCH BAR ==================== */
    .search-container {
      position: relative;
      margin-bottom: 20px;
    }

    #listSearch {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 1);
      background: rgba(15, 23, 42, 0.95);
      padding: 14px 20px;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    #listSearch:focus {
      border-color: var(--accent-main);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    #listSearch::placeholder {
      color: rgba(107, 114, 128, 0.9);
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-dim);
      pointer-events: none;
    }

    /* ==================== STATS BADGE ==================== */
    .stats-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(55, 65, 81, 1);
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 16px;
    }

    .stats-badge strong {
      color: var(--text-main);
    }

    /* ==================== RESPONSIVE DESIGN ==================== */
    @media (max-width: 768px) {
      .overlay {
        padding: 0;
        align-items: flex-end;
      }

      .overlay-card {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 24px 24px 0 0;
        margin-bottom: env(safe-area-inset-bottom, 0);
      }

      #leftDock, #rightDock {
        left: 8px;
        right: 8px;
        top: 8px;
      }

      #rightDock {
        align-items: flex-end;
      }

      #mapNavToggle {
        bottom: 80px;
        right: 8px;
      }

      #mapNavigation {
        bottom: 100px;
      }

      .nav-btn {
        width: 56px;
        height: 56px;
        font-size: 24px;
      }

      .dock-btn {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }

      .legend-dot {
        width: 12px;
        height: 12px;
      }

      .legend-number {
        font-size: 10px;
      }

      .cols {
        flex-direction: column;
        gap: 0;
      }

      #toastContainer {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .toast {
        max-width: none;
      }

      .confirm-modal-content {
        padding: 24px;
        margin: 20px;
      }

      #crosshair {
        display: block !important;
      }

      #temporaryPin {
        display: none !important;
      }

      /* Safe area for iPhone X+ */
      @supports (padding: max(0px)) {
        #leftDock, #rightDock {
          top: max(8px, env(safe-area-inset-top));
        }
        
        #mapNavToggle {
          bottom: max(80px, env(safe-area-inset-bottom, 20px) + 60px);
        }
      }
    }

    @media (max-width: 480px) {
      .overlay-body {
        padding: 16px;
      }

      .overlay-header {
        padding: 12px 16px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }

      .actions-row {
        flex-direction: column;
      }

      .actions-row .btn {
        width: 100%;
      }
    }

    /* ==================== DARK MODE SUPPORT ==================== */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-main: #0a0a0a;
        --bg-panel: rgba(20, 20, 20, 0.98);
      }
    }

    /* ==================== PRINT STYLES ==================== */
    @media print {
      #map, .dock-btn, #syncStatus, #toastContainer {
        display: none !important;
      }
      
      .overlay-card {
        box-shadow: none;
        border: 1px solid #ccc;
        max-width: none;
        max-height: none;
      }
    }

    /* ==================== UTILITY CLASSES ==================== */
    .hidden {
      display: none !important;
    }

    .fade-in {
      animation: fadeIn 0.3s ease;
    }

    .slide-up {
      animation: slideUp 0.3s ease;
    }

    .text-success {
      color: var(--success);
    }

    .text-error {
      color: var(--error);
    }

    .text-warning {
      color: var(--warning);
    }

    .text-info {
      color: var(--info);
    }

    .text-dim {
      color: var(--text-dim);
    }

    .text-center {
      text-align: center;
    }

    .mb-4 {
      margin-bottom: 16px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .w-full {
      width: 100%;
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-4 {
      gap: 16px;
    }

    /* ==================== CUSTOM SCROLLBAR ==================== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.8);
    }

    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.5) rgba(15, 23, 42, 0.5);
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }

    .shake {
      animation: shake 0.5s ease;
    }

    /* ==================== ACCESSIBILITY ==================== */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus styles for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--accent-main);
      outline-offset: 2px;
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
      :root {
        --text-main: #ffffff;
        --text-dim: #cccccc;
        --border-soft: #666666;
      }
      
      .btn-primary {
        background: #0056cc;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="loading-logo"></div>
    <div class="loading-spinner"></div>
    <div class="loading-text">
      <strong>Lost Trace Unit</strong><br>
      Caricamento mappa...
    </div>
  </div>

  <!-- MAPPA -->
  <div id="map"></div>
  <div id="crosshair"></div>
  <div id="temporaryPin"></div>
  
  <!-- Toast Container -->
  <div id="toastContainer"></div>
  
  <!-- SYNC STATUS -->
  <div id="syncStatus"></div>
  
  <!-- DOCK SINISTRO -->
  <div id="leftDock">
    <button id="saveAllBtn" class="dock-btn" title="Salva tutti i dati" aria-label="Salva tutti i dati">
      <span>üíæ</span>
      <span class="badge" id="saveBadge" style="display: none;">!</span>
    </button>
    <button id="streetviewBtn" class="dock-btn" title="StreetView" aria-label="Apri StreetView">
      üåç
    </button>
    <button id="filtersBtn" class="dock-btn" title="Filtri" aria-label="Apri filtri">
      üîç
    </button>
  </div>
  
  <!-- DOCK DESTRO -->
  <div id="rightDock">
    <button id="importLinkBtn" class="dock-btn" title="Importa link" aria-label="Importa da link">
      üìé
    </button>
    <button id="settingsBtn" class="dock-btn" title="Impostazioni" aria-label="Apri impostazioni">
      ‚öôÔ∏è
    </button>
    <button id="crosshairToggleBtn" class="dock-btn" title="Mostra/Nascondi mirino" aria-label="Attiva/disattiva mirino">
      üéØ
    </button>
    <button id="btnList" class="dock-btn" title="Lista spot" aria-label="Apri lista spot">
      üìã
      <span class="badge" id="spotsBadge" style="display: none;">0</span>
    </button>
    <button id="btnAdd" class="dock-btn" title="Aggiungi spot" aria-label="Aggiungi nuovo spot">
      ‚ûï
    </button>
    <button id="btnRandom" class="dock-btn" title="Random spot" aria-label="Spot casuale">
      üé≤
    </button>
    <button id="missionBtn" class="dock-btn" title="Missione spot selezionato" aria-label="Apri missione">
      üìú
    </button>
    
    <!-- LEGENDA -->
    <div id="legendContainer">
      <div class="legend-row"><div class="legend-dot" style="background:#b91c1c"></div><span class="legend-number">1</span></div>
      <div class="legend-row"><div class="legend-dot" style="background:#f97316"></div><span class="legend-number">2</span></div>
      <div class="legend-row"><div class="legend-dot" style="background:#eab308"></div><span class="legend-number">3</span></div>
      <div class="legend-row"><div class="legend-dot" style="background:#2563eb"></div><span class="legend-number">4</span></div>
      <div class="legend-row"><div class="legend-dot" style="background:#16a34a"></div><span class="legend-number">5</span></div>
      <div class="legend-row"><div class="legend-dot" style="background:#a855f7"></div><span class="legend-number">6</span></div>
    </div>
    
    <button id="dockToggleBtn" class="dock-btn" title="Mostra/Nascondi pulsanti" aria-label="Comprimi/espandi dock">
      ‚¨ÜÔ∏è
    </button>
  </div>
  
  <!-- MAP NAVIGATION CONTROLS -->
  <button id="mapNavToggle" class="dock-btn" title="Navigazione rapida mappe" aria-label="Navigazione mappe">
    üó∫Ô∏è
  </button>
  <div id="mapNavigation">
    <div id="mapNavInfo">
      <span id="currentMapName">OSM Standard</span>
      <span id="mapCounter">1/12</span>
    </div>
    <div id="mapNavControls">
      <button id="prevMapBtn" class="nav-btn" aria-label="Mappa precedente">‚óÄ</button>
      <button id="nextMapBtn" class="nav-btn" aria-label="Mappa successiva">‚ñ∂</button>
    </div>
  </div>
  
  <!-- LIST PANEL -->
  <div id="listPanel" class="overlay hidden">
    <div class="overlay-backdrop"></div>
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-header-title">
          <strong>Lista spot</strong>
          <small>Tocca uno spot per centrare la mappa</small>
        </div>
        <div class="flex items-center gap-4">
          <button id="btnCloseList" class="icon-btn" aria-label="Chiudi lista">
            ‚úï
          </button>
        </div>
      </div>
      <div class="overlay-body">
        <div class="search-container">
          <input id="listSearch" type="search" placeholder="Cerca per nome, descrizione, tipo..." aria-label="Cerca spot" />
          <div class="search-icon">üîç</div>
        </div>
        <div class="stats-badge">
          <span>Totale: <strong id="totalSpotsCount">0</strong></span>
          <span>Filtrati: <strong id="filteredSpotsCount">0</strong></span>
        </div>
        <div class="filters-panel" id="filtersPanel" style="display: none;">
          <div class="filter-group">
            <div class="filter-group-title">Tipologia</div>
            <div class="filter-chips" id="tipoFilters">
              <!-- Dinamico -->
            </div>
          </div>
          <div class="filter-group">
            <div class="filter-group-title">Voto</div>
            <div class="filter-chips" id="votoFilters">
              <!-- Dinamico -->
            </div>
          </div>
          <div class="actions-row">
            <button id="clearFiltersBtn" class="btn btn-secondary">Pulisci filtri</button>
            <button id="applyFiltersBtn" class="btn btn-primary">Applica</button>
          </div>
        </div>
        <ul id="listContent"></ul>
        <div id="emptyState" class="text-center text-dim mt-4" style="display: none;">
          <p>Nessuno spot trovato.</p>
          <button id="btnAddFromList" class="btn btn-primary mt-4">‚ûï Aggiungi spot</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ADD PANEL -->
  <div id="addPanel" class="overlay hidden">
    <div class="overlay-backdrop"></div>
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-header-title">
          <strong>Nuovo spot</strong>
          <small>Lost Trace Unit ‚Äì aggiungi un punto condiviso</small>
        </div>
        <button id="btnCloseAdd" class="icon-btn" aria-label="Chiudi">
          ‚úï
        </button>
      </div>
      <div class="overlay-body">
        <form id="addForm">
          <div class="form-row">
            <label for="fieldName">Nome *</label>
            <input id="fieldName" class="input" type="text" placeholder="Es. Villa, Casetta, Hotel..." required />
          </div>
          <div class="form-row">
            <label for="fieldDesc">Descrizione</label>
            <textarea id="fieldDesc" class="textarea" placeholder="Note, accesso, storia, warning..."></textarea>
          </div>
          <div class="cols">
            <div class="form-row">
              <label for="fieldVoto">Voto (1‚Äì6)</label>
              <select id="fieldVoto" class="select voto-select">
                <option value="">Nessun voto</option>
                <option value="1" style="color:#b91c1c">‚óè 1</option>
                <option value="2" style="color:#f97316">‚óè 2</option>
                <option value="3" style="color:#eab308">‚óè 3</option>
                <option value="4" style="color:#2563eb">‚óè 4</option>
                <option value="5" style="color:#16a34a">‚óè 5</option>
                <option value="6" style="color:#a855f7">‚óè 6</option>
              </select>
            </div>
            <div class="form-row">
              <label for="fieldTipo">Tipologia</label>
              <select id="fieldTipo" class="select">
                <option value="">Auto-rileva</option>
                <option value="hotel">üè® Hotel</option>
                <option value="villa">üè° Villa</option>
                <option value="casa">üè† Casa</option>
                <option value="industria">üè≠ Industria</option>
                <option value="scuola">üè´ Scuola</option>
                <option value="chiesa">‚õ™ Chiesa</option>
                <option value="colonia">üèöÔ∏è Colonia</option>
                <option value="istituzione">üè• Istituzione</option>
                <option value="svago">üé≠ Svago</option>
                <option value="castello">üè∞ Castello</option>
                <option value="nave">üö¢ Nave</option>
                <option value="diga">üíß Diga</option>
                <option value="militare">ü™ñ Militare</option>
                <option value="altro">üìç Altro</option>
              </select>
            </div>
          </div>
          <div class="cols">
            <div class="form-row">
              <label for="fieldLat">Latitudine *</label>
              <input id="fieldLat" class="input" type="text" placeholder="Clicca sulla mappa per posizionare il pin" required />
            </div>
            <div class="form-row">
              <label for="fieldLng">Longitudine *</label>
              <input id="fieldLng" class="input" type="text" placeholder="Clicca sulla mappa per posizionare il pin" required />
            </div>
          </div>
          <div class="actions-row">
            <button type="button" id="btnUseCurrentPin" class="btn btn-secondary">Usa pin corrente</button>
            <button type="submit" class="btn btn-primary">
              <span>üíæ</span>
              Salva spot
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- EDIT PANEL -->
  <div id="editPanel" class="overlay hidden">
    <div class="overlay-backdrop"></div>
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-header-title">
          <strong>Modifica spot</strong>
          <small>Lost Trace Unit ‚Äì aggiorna i dettagli</small>
        </div>
        <button id="btnCloseEdit" class="icon-btn" aria-label="Chiudi">
          ‚úï
        </button>
      </div>
      <div class="overlay-body">
        <form id="editForm">
          <input type="hidden" id="editSpotId" />
          <div class="form-row">
            <label for="editFieldName">Nome *</label>
            <input id="editFieldName" class="input" type="text" placeholder="Es. Villa, Casetta, Hotel..." required />
          </div>
          <div class="form-row">
            <label for="editFieldDesc">Descrizione</label>
            <textarea id="editFieldDesc" class="textarea" placeholder="Note, accesso, storia, warning..."></textarea>
          </div>
          <div class="cols">
            <div class="form-row">
              <label for="editFieldVoto">Voto (1‚Äì6)</label>
              <select id="editFieldVoto" class="select voto-select">
                <option value="">Nessun voto</option>
                <option value="1" style="color:#b91c1c">‚óè 1</option>
                <option value="2" style="color:#f97316">‚óè 2</option>
                <option value="3" style="color:#eab308">‚óè 3</option>
                <option value="4" style="color:#2563eb">‚óè 4</option>
                <option value="5" style="color:#16a34a">‚óè 5</option>
                <option value="6" style="color:#a855f7">‚óè 6</option>
              </select>
            </div>
            <div class="form-row">
              <label for="editFieldTipo">Tipologia</label>
              <select id="editFieldTipo" class="select">
                <option value="">Auto-rileva</option>
                <option value="hotel">üè® Hotel</option>
                <option value="villa">üè° Villa</option>
                <option value="casa">üè† Casa</option>
                <option value="industria">üè≠ Industria</option>
                <option value="scuola">üè´ Scuola</option>
                <option value="chiesa">‚õ™ Chiesa</option>
                <option value="colonia">üèöÔ∏è Colonia</option>
                <option value="istituzione">üè• Istituzione</option>
                <option value="svago">üé≠ Svago</option>
                <option value="castello">üè∞ Castello</option>
                <option value="nave">üö¢ Nave</option>
                <option value="diga">üíß Diga</option>
                <option value="militare">ü™ñ Militare</option>
                <option value="altro">üìç Altro</option>
              </select>
            </div>
          </div>
          <div class="cols">
            <div class="form-row">
              <label for="editFieldLat">Latitudine *</label>
              <input id="editFieldLat" class="input" type="text" placeholder="Clicca sulla mappa per posizionare il pin" required />
            </div>
            <div class="form-row">
              <label for="editFieldLng">Longitudine *</label>
              <input id="editFieldLng" class="input" type="text" placeholder="Clicca sulla mappa per posizionare il pin" required />
            </div>
          </div>
          <div class="actions-row">
            <button type="button" id="btnUseCurrentPinEdit" class="btn btn-secondary">Usa pin corrente</button>
            <button type="submit" class="btn btn-primary">
              <span>üíæ</span>
              Salva modifiche
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- SETTINGS PANEL -->
  <div id="settingsPanel" class="overlay hidden">
    <div class="overlay-backdrop"></div>
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-header-title">
          <strong>Impostazioni LTU</strong>
          <small>Stile mappa, random, import/export</small>
        </div>
        <button id="btnCloseSettings" class="icon-btn" aria-label="Chiudi">
          ‚úï
        </button>
      </div>
      <div class="overlay-body">
        <section class="settings-section">
          <div class="settings-section-title">Stile mappa</div>
          <div class="settings-section-desc">
            Cambia la base map condivisa tra tutti gli utenti.
          </div>
          <div class="settings-row">
            <label for="mapStyleSelect">Tileset</label>
            <select id="mapStyleSelect" class="select">
              <option value="osm">OSM Standard</option>
              <option value="osmHot">OSM Humanitarian</option>
              <option value="satellite">Satellite Esri</option>
              <option value="satellite2">Satellite Google</option>
              <option value="satellite3">Satellite NASA</option>
              <option value="topo">OpenTopoMap</option>
              <option value="dark">Carto Dark</option>
              <option value="cartoLight">Carto Light</option>
              <option value="stamenToner">Stamen Toner</option>
              <option value="esriTopo">Esri Topo</option>
              <option value="esriOcean">Esri Ocean</option>
              <option value="esriGray">Esri Gray</option>
            </select>
          </div>
          <div class="settings-row">
            <label for="crosshairEnabled">Abilita mirino (mobile)</label>
            <input id="crosshairEnabled" type="checkbox" />
          </div>
        </section>
        <section class="settings-section">
          <div class="settings-section-title">Random & missioni</div>
          <div class="settings-section-desc">
            Come estrarre gli spot casuali per le sessioni LTU.
          </div>
          <div class="settings-row">
            <label for="randomLowRatedCheckbox">
              Includi anche spot con voto 1‚Äì2 nei random
            </label>
            <input id="randomLowRatedCheckbox" type="checkbox" />
          </div>
        </section>
        <section class="settings-section">
          <div class="settings-section-title">Import / Export</div>
          <div class="settings-section-desc">
            Puoi esportare tutti gli spot in CSV per GMaps o importare un JSON semplice.
          </div>
          <textarea id="importTextarea" placeholder='Incolla qui JSON o CSV da importare...'></textarea>
          <div class="settings-buttons-row">
            <button id="btnImportJson" class="btn btn-secondary">üì• Importa JSON</button>
            <button id="btnExportCsv" class="btn btn-secondary">üì§ Export GMaps CSV</button>
            <button id="btnExportJson" class="btn btn-secondary">üì§ Export JSON</button>
          </div>
          <div style="margin-top:12px;font-size:12px;color:var(--text-dim);">
            JSON atteso: array di oggetti con <code>name, desc, lat, lng, voto</code> oppure
            oggetto con <code>places</code>.
          </div>
          <textarea id="exportTextarea" placeholder="Qui apparir√† il CSV/JSON generato..." readonly></textarea>
        </section>
        <div class="actions-row">
          <button id="btnSaveAllSettings" class="btn btn-primary">
            <span>üíæ</span>
            Salva tutte le impostazioni
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- MISSION PANEL -->
  <div id="missionPanel" class="overlay hidden">
    <div class="overlay-backdrop"></div>
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-header-title">
          <strong>Missione LTU</strong>
          <small>Briefing sullo spot selezionato</small>
        </div>
        <button id="btnCloseMission" class="icon-btn" aria-label="Chiudi">
          ‚úï
        </button>
      </div>
      <div class="overlay-body">
        <div id="missionBodyTitle" class="mb-4"></div>
        <div id="missionBodyCoords" class="text-dim mb-4"></div>
        <textarea id="missionText" class="textarea" placeholder="Scrivi qui il briefing, obiettivi, rischi, note di esplorazione..."></textarea>
        <div class="actions-row">
          <button id="btnSaveMission" class="btn btn-primary">
            <span>üíæ</span>
            Salva missione
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- IMPORT LINK PANEL -->
  <div id="importLinkPanel" class="overlay hidden">
    <div class="overlay-backdrop"></div>
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-header-title">
          <strong>Importa da link Google Maps</strong>
          <small>Incolla un link per estrarre coordinate</small>
        </div>
        <button id="btnCloseImportLink" class="icon-btn" aria-label="Chiudi">
          ‚úï
        </button>
      </div>
      <div class="overlay-body">
        <div class="instructions mb-4">
          Incolla qui un link di Google Maps (es. https://maps.app.goo.gl/HY2ynACBvCrSzqxd7) 
          per estrarre automaticamente le coordinate.
        </div>
        <input type="text" id="linkInput" class="input mb-4" placeholder="https://maps.app.goo.gl/..." />
        <div class="actions-row mb-4">
          <button type="button" id="btnDecodeLink" class="btn btn-primary">Decodifica link</button>
        </div>
        <div id="linkResult" style="display: none;">
          <div class="form-row">
            <label>Coordinate trovate:</label>
            <div class="text-success" id="coordsFound"></div>
          </div>
          <div class="form-row">
            <label for="linkSpotName">Nome spot *</label>
            <input type="text" id="linkSpotName" class="input" placeholder="Nome dello spot..." required />
          </div>
          <div class="form-row">
            <label for="linkSpotDesc">Descrizione</label>
            <textarea id="linkSpotDesc" class="textarea" placeholder="Descrizione..."></textarea>
          </div>
          <div class="actions-row">
            <button type="button" id="btnAddFromLink" class="btn btn-primary">Aggiungi spot</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet Rotate Plugin -->
  <script src="https://unpkg.com/leaflet.touchrotateloading/leaflet.touchrotateloading.js"></script>
  
  <!-- App JavaScript -->
  <script>
    // ==================== CONFIGURAZIONE ====================
    const CONFIG = {
      API_BASE_URL: window.location.origin,
      MAP_LAYERS: {
        osm: { name: "OSM Standard", url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" },
        osmHot: { name: "OSM Humanitarian", url: "https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png" },
        satellite: { name: "Satellite Esri", url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}" },
        satellite2: { name: "Satellite Google", url: "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}" },
        satellite3: { name: "Satellite NASA", url: "https://map1.vis.earthdata.nasa.gov/wmts-webmerc/MODIS_Terra_CorrectedReflectance_TrueColor/default/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg" },
        topo: { name: "OpenTopoMap", url: "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png" },
        dark: { name: "Carto Dark", url: "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png" },
        cartoLight: { name: "Carto Light", url: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png" },
        stamenToner: { name: "Stamen Toner", url: "https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png" },
        esriTopo: { name: "Esri Topo", url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}" },
        esriOcean: { name: "Esri Ocean", url: "https://services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}" },
        esriGray: { name: "Esri Gray", url: "https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}" }
      },
      VOTO_COLORS: {
        1: '#b91c1c',
        2: '#f97316',
        3: '#eab308',
        4: '#2563eb',
        5: '#16a34a',
        6: '#a855f7'
      },
      TIPO_EMOJIS: {
        hotel: 'üè®',
        villa: 'üè°',
        casa: 'üè†',
        industria: 'üè≠',
        scuola: 'üè´',
        chiesa: '‚õ™',
        colonia: 'üèöÔ∏è',
        istituzione: 'üè•',
        svago: 'üé≠',
        castello: 'üè∞',
        nave: 'üö¢',
        diga: 'üíß',
        militare: 'ü™ñ',
        altro: 'üìç'
      }
    };

    // ==================== STATE MANAGEMENT ====================
    const AppState = {
      map: null,
      markersLayer: null,
      baseLayers: {},
      settings: {
        baseLayer: 'osm',
        randomIncludeLowRated: false,
        crosshairEnabled: false
      },
      spots: [],
      currentSpot: null,
      missions: {},
      filters: {
        tipo: null,
        voto: null,
        search: ''
      },
      pendingOperations: 0,
      isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
      temporaryPin: { lat: null, lng: null }
    };

    // ==================== UTILITY FUNCTIONS ====================
    class Utils {
      static showLoading(show) {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
          loadingScreen.style.display = show ? 'flex' : 'none';
        }
      }

      static showToast(message, type = 'info', duration = 5000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
          <div class="toast-icon">
            ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
          </div>
          <div class="toast-content">
            <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" aria-label="Chiudi">‚úï</button>
        `;

        container.appendChild(toast);

        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.onclick = () => toast.remove();

        if (duration > 0) {
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, duration);
        }

        return toast;
      }

      static updateSyncStatus(message, type = 'info') {
        const statusEl = document.getElementById('syncStatus');
        if (!statusEl) return;

        statusEl.textContent = message;
        statusEl.className = type;
        statusEl.classList.add('show');

        setTimeout(() => {
          statusEl.classList.remove('show');
        }, type === 'error' ? 5000 : 3000);
      }

      static async confirm(title, message) {
        return new Promise((resolve) => {
          const modal = document.createElement('div');
          modal.className = 'confirm-modal';
          modal.innerHTML = `
            <div class="confirm-modal-content">
              <div class="confirm-modal-title">${title}</div>
              <div class="confirm-modal-message">${message}</div>
              <div class="confirm-modal-buttons">
                <button class="btn btn-secondary" id="confirmCancel">Annulla</button>
                <button class="btn btn-danger" id="confirmOk">Conferma</button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          modal.querySelector('#confirmCancel').onclick = () => {
            modal.remove();
            resolve(false);
          };

          modal.querySelector('#confirmOk').onclick = () => {
            modal.remove();
            resolve(true);
          };

          modal.onclick = (e) => {
            if (e.target === modal) {
              modal.remove();
              resolve(false);
            }
          };
        });
      }

      static getRatingColor(voto) {
        return CONFIG.VOTO_COLORS[voto] || '#64748b';
      }

      static getEmojiByTipo(tipo) {
        return CONFIG.TIPO_EMOJIS[tipo] || 'üìç';
      }

      static getTipo(name, desc) {
        const text = ((name || '') + ' ' + (desc || '')).toLowerCase();
        
        if (text.includes('hotel') || text.includes('ostello') || text.includes('residence')) return 'hotel';
        if (text.includes('villa') || text.includes('villone') || text.includes('villino')) return 'villa';
        if (text.includes('casa') || text.includes('casetta') || text.includes('casone')) return 'casa';
        if (text.includes('fabbrica') || text.includes('capannone') || text.includes('magazzino')) return 'industria';
        if (text.includes('scuola') || text.includes('itis')) return 'scuola';
        if (text.includes('chiesa')) return 'chiesa';
        if (text.includes('colonia')) return 'colonia';
        if (text.includes('prigione') || text.includes('manicomio') || text.includes('ospedale')) return 'istituzione';
        if (text.includes('discoteca') || text.includes('bar') || text.includes('ristorante')) return 'svago';
        if (text.includes('castello')) return 'castello';
        if (text.includes('nave')) return 'nave';
        if (text.includes('diga')) return 'diga';
        if (text.includes('base nato')) return 'militare';
        
        return 'altro';
      }

      static formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('it-IT', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }

      static debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
    }

    // ==================== API SERVICE ====================
    class ApiService {
      static async request(endpoint, options = {}) {
        const defaultHeaders = {
          'Content-Type': 'application/json',
          'Authorization': 'Basic ' + btoa('unit:ltunit')
        };

        const config = {
          ...options,
          headers: {
            ...defaultHeaders,
            ...options.headers
          }
        };

        try {
          const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`, config);
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.message || `HTTP ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error('API Error:', error);
          Utils.showToast(error.message, 'error');
          throw error;
        }
      }

      static async getSpots(filters = {}) {
        const params = new URLSearchParams();
        if (filters.tipo) params.append('tipo', filters.tipo);
        if (filters.voto) params.append('voto', filters.voto);
        if (filters.search) params.append('search', filters.search);

        const query = params.toString();
        const endpoint = query ? `/api/spots?${query}` : '/api/spots';
        
        return this.request(endpoint);
      }

      static async getSpot(id) {
        return this.request(`/api/spots/${id}`);
      }

      static async createSpot(data) {
        return this.request('/api/spots', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      }

      static async updateSpot(id, data) {
        return this.request(`/api/spots/${id}`, {
          method: 'PUT',
          body: JSON.stringify(data)
        });
      }

      static async deleteSpot(id) {
        return this.request(`/api/spots/${id}`, {
          method: 'DELETE'
        });
      }

      static async getMission(spotId) {
        return this.request(`/api/spots/${spotId}/mission`);
      }

      static async saveMission(spotId, missionText) {
        return this.request(`/api/spots/${spotId}/mission`, {
          method: 'POST',
          body: JSON.stringify({ mission_text: missionText })
        });
      }

      static async getSettings() {
        return this.request('/api/settings');
      }

      static async saveSettings(data) {
        return this.request('/api/settings', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      }

      static async decodeGoogleMapsUrl(url) {
        return this.request('/api/decode-gmaps-url', {
          method: 'POST',
          body: JSON.stringify({ url })
        });
      }
    }

    // ==================== MAP MANAGER ====================
    class MapManager {
      static init() {
        AppState.map = L.map('map', {
          zoomControl: false,
          gestureHandling: true,
          maxZoom: 22,
          minZoom: 1,
          touchRotate: true,
          rotate: true,
          rotateControl: true
        });

        this.initLayers();
        this.initMarkers();
        this.initEvents();

        AppState.map.setView([44.5, 8.9], 7);
        
        // Add rotate control
        L.control.rotate({ position: 'topright' }).addTo(AppState.map);
      }

      static initLayers() {
        Object.entries(CONFIG.MAP_LAYERS).forEach(([key, layer]) => {
          AppState.baseLayers[key] = L.tileLayer(layer.url, {
            maxZoom: key === 'satellite3' ? 9 : 22,
            attribution: `&copy; ${layer.name}`
          });
        });

        const defaultLayer = AppState.baseLayers[AppState.settings.baseLayer] || AppState.baseLayers.osm;
        defaultLayer.addTo(AppState.map);
      }

      static initMarkers() {
        AppState.markersLayer = L.layerGroup().addTo(AppState.map);
      }

      static initEvents() {
        // Map click
        AppState.map.on('click', (e) => {
          if (AppState.isMobile) return;

          AppState.temporaryPin = { lat: e.latlng.lat, lng: e.latlng.lng };
          this.showTemporaryPin(e.latlng.lat, e.latlng.lng);
          FormManager.updateCoordinates(e.latlng.lat, e.latlng.lng);
        });

        // Right click to remove pin
        AppState.map.on('contextmenu', (e) => {
          e.originalEvent.preventDefault();
          this.removeTemporaryPin();
          return false;
        });

        // Disable context menu on map
        AppState.map.getContainer().addEventListener('contextmenu', (e) => {
          e.preventDefault();
          return false;
        });
      }

      static showTemporaryPin(lat, lng) {
        const pin = document.getElementById('temporaryPin');
        if (!pin) return;

        const point = AppState.map.latLngToContainerPoint([lat, lng]);
        const mapRect = AppState.map.getContainer().getBoundingClientRect();
        
        pin.style.left = (mapRect.left + point.x) + 'px';
        pin.style.top = (mapRect.top + point.y) + 'px';
        pin.style.display = 'block';
      }

      static removeTemporaryPin() {
        const pin = document.getElementById('temporaryPin');
        if (pin) {
          pin.style.display = 'none';
        }
        AppState.temporaryPin = { lat: null, lng: null };
      }

      static switchLayer(layerKey) {
        if (!AppState.baseLayers[layerKey]) return;

        Object.values(AppState.baseLayers).forEach(layer => {
          if (AppState.map.hasLayer(layer)) {
            AppState.map.removeLayer(layer);
          }
        });

        AppState.baseLayers[layerKey].addTo(AppState.map);
        AppState.settings.baseLayer = layerKey;
        
        const mapStyleSelect = document.getElementById('mapStyleSelect');
        if (mapStyleSelect) {
          mapStyleSelect.value = layerKey;
        }
      }

      static renderSpots() {
        if (!AppState.markersLayer) return;
        
        AppState.markersLayer.clearLayers();
        
        AppState.spots.forEach(spot => {
          this.createMarker(spot);
        });
      }

      static createMarker(spot) {
        const color = Utils.getRatingColor(spot.voto);
        const emoji = Utils.getEmojiByTipo(spot.tipo);

        const iconHtml = `
          <div style="filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.5)); margin-top: -6px;">
            <svg width="32" height="44" viewBox="0 0 32 44" xmlns="http://www.w3.org/2000/svg">
              <path d="M16,0 C7.163,0 0,7.163 0,16 C0,25.938 16,44 16,44 C16,44 32,25.938 32,16 C32,7.163 24.837,0 16,0 Z"
                    fill="${color}"
                    stroke="none"/>
              <circle cx="16" cy="15" r="10" fill="#ffffff" stroke="#00000011" stroke-width="0.5"/>
              <text x="16" y="20" font-size="16" text-anchor="middle" dominant-baseline="middle" fill="#000">${emoji}</text>
            </svg>
          </div>
        `;

        const icon = L.divIcon({
          html: iconHtml,
          className: 'ltu-custom-pin',
          iconSize: [32, 44],
          iconAnchor: [16, 44],
          popupAnchor: [0, -38]
        });

        const marker = L.marker([spot.lat, spot.lng], { icon }).addTo(AppState.markersLayer);
        marker.bindPopup(this.createPopupHtml(spot));

        marker.on('click', () => {
          AppState.currentSpot = spot;
        });

        return marker;
      }

      static createPopupHtml(spot) {
        return `
          <div class="popup-content">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
              <div style="font-size:36px;">${Utils.getEmojiByTipo(spot.tipo)}</div>
              <div style="flex:1;">
                <div style="font-size:16px; font-weight:700; margin-bottom:4px;">${spot.name}</div>
                ${spot.voto ? `
                  <span style="background:${Utils.getRatingColor(spot.voto)}; color:#fff; padding:4px 12px; border-radius:999px; font-size:13px; font-weight:700;">
                    ${spot.voto} ‚òÖ
                  </span>
                ` : ''}
              </div>
            </div>
            ${spot.description ? `<div style="font-size:13px; line-height:1.5; margin-bottom:16px;">${spot.description}</div>` : ''}
            <div style="font-size:12px; color:#94a3b8; margin-bottom:16px;">
              ${spot.lat.toFixed(6)}, ${spot.lng.toFixed(6)}
              ${spot.created_at ? `<br>Creato: ${Utils.formatDate(spot.created_at)}` : ''}
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <a href="https://www.google.com/maps?q=${spot.lat},${spot.lng}"
                 target="_blank"
                 style="background:#2563eb; color:white; padding:10px 16px; border-radius:8px; text-decoration:none; flex:1; text-align:center; font-weight:600;">
                Google Maps ‚Üó
              </a>
              <button onclick="window.editSpot('${spot.id}')"
                      style="background:#10b981; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600;">
                Modifica
              </button>
              <button onclick="window.deleteSpot('${spot.id}')"
                      style="background:#ef4444; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600;">
                Elimina
              </button>
            </div>
          </div>
        `;
      }

      static centerOnSpot(spot) {
        if (!spot) return;
        AppState.map.setView([spot.lat, spot.lng], 16);
        
        // Find and open marker popup
        AppState.markersLayer.eachLayer((layer) => {
          if (layer.getLatLng().lat === spot.lat && layer.getLatLng().lng === spot.lng) {
            layer.openPopup();
          }
        });
      }

      static getCurrentCenter() {
        return AppState.map.getCenter();
      }
    }

    // ==================== FORM MANAGER ====================
    class FormManager {
      static updateCoordinates(lat, lng) {
        const latInput = document.getElementById('fieldLat');
        const lngInput = document.getElementById('fieldLng');
        const editLatInput = document.getElementById('editFieldLat');
        const editLngInput = document.getElementById('editFieldLng');

        if (latInput && lngInput) {
          latInput.value = lat.toFixed(6);
          lngInput.value = lng.toFixed(6);
        }

        if (editLatInput && editLngInput) {
          editLatInput.value = lat.toFixed(6);
          editLngInput.value = lng.toFixed(6);
        }
      }

      static useCurrentPin() {
        if (AppState.temporaryPin.lat && AppState.temporaryPin.lng) {
          this.updateCoordinates(AppState.temporaryPin.lat, AppState.temporaryPin.lng);
        } else {
          const center = MapManager.getCurrentCenter();
          this.updateCoordinates(center.lat, center.lng);
        }
      }

      static async handleAddSubmit(e) {
        e.preventDefault();

        if (AppState.pendingOperations > 0) {
          Utils.showToast('Attendi il completamento delle operazioni in corso', 'warning');
          return;
        }

        const formData = {
          name: document.getElementById('fieldName').value.trim(),
          desc: document.getElementById('fieldDesc').value.trim(),
          lat: parseFloat(document.getElementById('fieldLat').value),
          lng: parseFloat(document.getElementById('fieldLng').value),
          voto: document.getElementById('fieldVoto').value || null,
          tipo: document.getElementById('fieldTipo').value || Utils.getTipo(document.getElementById('fieldName').value)
        };

        if (!formData.name || isNaN(formData.lat) || isNaN(formData.lng)) {
          Utils.showToast('Compila tutti i campi obbligatori', 'error');
          return;
        }

        try {
          AppState.pendingOperations++;
          Utils.updateSyncStatus('Salvataggio spot...', 'syncing');

          const response = await ApiService.createSpot(formData);
          
          if (response.success) {
            AppState.spots.push(response.data);
            MapManager.renderSpots();
            ListManager.render();
            
            document.getElementById('addPanel').classList.add('hidden');
            document.getElementById('addForm').reset();
            
            Utils.updateSyncStatus('Spot salvato', 'success');
            Utils.showToast('Spot aggiunto con successo!', 'success');
            
            MapManager.centerOnSpot(response.data);
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore salvataggio', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        } finally {
          AppState.pendingOperations--;
        }
      }

      static async handleEditSubmit(e) {
        e.preventDefault();

        if (AppState.pendingOperations > 0) {
          Utils.showToast('Attendi il completamento delle operazioni in corso', 'warning');
          return;
        }

        const spotId = document.getElementById('editSpotId').value;
        const formData = {
          name: document.getElementById('editFieldName').value.trim(),
          desc: document.getElementById('editFieldDesc').value.trim(),
          lat: parseFloat(document.getElementById('editFieldLat').value),
          lng: parseFloat(document.getElementById('editFieldLng').value),
          voto: document.getElementById('editFieldVoto').value || null,
          tipo: document.getElementById('editFieldTipo').value || Utils.getTipo(document.getElementById('editFieldName').value)
        };

        if (!formData.name || isNaN(formData.lat) || isNaN(formData.lng)) {
          Utils.showToast('Compila tutti i campi obbligatori', 'error');
          return;
        }

        try {
          AppState.pendingOperations++;
          Utils.updateSyncStatus('Aggiornamento spot...', 'syncing');

          const response = await ApiService.updateSpot(spotId, formData);
          
          if (response.success) {
            const index = AppState.spots.findIndex(s => s.id === spotId);
            if (index !== -1) {
              AppState.spots[index] = response.data;
            }
            
            MapManager.renderSpots();
            ListManager.render();
            
            document.getElementById('editPanel').classList.add('hidden');
            
            Utils.updateSyncStatus('Spot aggiornato', 'success');
            Utils.showToast('Spot aggiornato con successo!', 'success');
            
            MapManager.centerOnSpot(response.data);
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore aggiornamento', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        } finally {
          AppState.pendingOperations--;
        }
      }

      static loadSpotIntoForm(spot) {
        if (!spot) return;

        document.getElementById('editSpotId').value = spot.id;
        document.getElementById('editFieldName').value = spot.name || '';
        document.getElementById('editFieldDesc').value = spot.description || '';
        document.getElementById('editFieldVoto').value = spot.voto || '';
        document.getElementById('editFieldLat').value = spot.lat.toFixed(6);
        document.getElementById('editFieldLng').value = spot.lng.toFixed(6);
        document.getElementById('editFieldTipo').value = spot.tipo || '';
      }
    }

    // ==================== LIST MANAGER ====================
    class ListManager {
      static render() {
        const listEl = document.getElementById('listContent');
        const searchEl = document.getElementById('listSearch');
        const totalEl = document.getElementById('totalSpotsCount');
        const filteredEl = document.getElementById('filteredSpotsCount');
        const emptyState = document.getElementById('emptyState');

        if (!listEl || !searchEl) return;

        const searchTerm = searchEl.value.toLowerCase().trim();
        AppState.filters.search = searchTerm;

        let filtered = AppState.spots.filter(spot => {
          const matchesSearch = !searchTerm || 
            spot.name.toLowerCase().includes(searchTerm) ||
            (spot.description && spot.description.toLowerCase().includes(searchTerm)) ||
            (spot.tipo && spot.tipo.toLowerCase().includes(searchTerm));

          const matchesTipo = !AppState.filters.tipo || spot.tipo === AppState.filters.tipo;
          const matchesVoto = !AppState.filters.voto || spot.voto == AppState.filters.voto;

          return matchesSearch && matchesTipo && matchesVoto;
        });

        // Update counts
        if (totalEl) totalEl.textContent = AppState.spots.length;
        if (filteredEl) filteredEl.textContent = filtered.length;

        // Clear list
        listEl.innerHTML = '';

        // Show/hide empty state
        if (emptyState) {
          emptyState.style.display = filtered.length === 0 ? 'block' : 'none';
        }

        // Sort by voto (desc), then by name
        filtered.sort((a, b) => {
          if (a.voto !== b.voto) return (b.voto || 0) - (a.voto || 0);
          return a.name.localeCompare(b.name);
        });

        // Render spots
        filtered.forEach(spot => {
          const row = this.createSpotRow(spot);
          listEl.appendChild(row);
        });
      }

      static createSpotRow(spot) {
        const row = document.createElement('li');
        row.className = 'spot-row';
        
        if (AppState.currentSpot && spot.id === AppState.currentSpot.id) {
          row.classList.add('highlighted');
        }

        row.innerHTML = `
          <div class="spot-emoji">${Utils.getEmojiByTipo(spot.tipo)}</div>
          <div class="spot-main">
            <div class="spot-main-title">
              <strong>${spot.name || 'Senza nome'}</strong>
              ${spot.voto ? `<div class="spot-vote-pill" style="background:${Utils.getRatingColor(spot.voto)}20;color:${Utils.getRatingColor(spot.voto)};">${spot.voto}‚òÖ</div>` : '<div class="spot-vote-pill">-</div>'}
            </div>
            <div class="spot-desc">${spot.description || ''}</div>
            <div class="spot-meta">
              <span>${spot.lat.toFixed(4)}, ${spot.lng.toFixed(4)}</span>
              <span>${spot.created_at ? Utils.formatDate(spot.created_at) : ''}</span>
            </div>
          </div>
          <div class="spot-actions">
            <button class="spot-action-btn" onclick="window.editSpot('${spot.id}')" title="Modifica">‚úèÔ∏è</button>
            <button class="spot-action-btn" onclick="window.deleteSpot('${spot.id}')" title="Elimina">üóëÔ∏è</button>
          </div>
        `;

        row.onclick = (e) => {
          if (!e.target.closest('.spot-actions')) {
            AppState.currentSpot = spot;
            MapManager.centerOnSpot(spot);
            document.getElementById('listPanel').classList.add('hidden');
          }
        };

        return row;
      }

      static initFilters() {
        const tipoFilters = document.getElementById('tipoFilters');
        const votoFilters = document.getElementById('votoFilters');

        if (!tipoFilters || !votoFilters) return;

        // Tipologia filters
        const tipos = [...new Set(AppState.spots.map(s => s.tipo).filter(Boolean))];
        tipoFilters.innerHTML = `
          <div class="filter-chip ${!AppState.filters.tipo ? 'active' : ''}" data-filter="tipo" data-value="">Tutte</div>
          ${tipos.map(tipo => `
            <div class="filter-chip ${AppState.filters.tipo === tipo ? 'active' : ''}" data-filter="tipo" data-value="${tipo}">
              ${Utils.getEmojiByTipo(tipo)} ${tipo}
            </div>
          `).join('')}
        `;

        // Voto filters
        votoFilters.innerHTML = `
          <div class="filter-chip ${!AppState.filters.voto ? 'active' : ''}" data-filter="voto" data-value="">Tutti</div>
          ${[1, 2, 3, 4, 5, 6].map(voto => `
            <div class="filter-chip ${AppState.filters.voto == voto ? 'active' : ''}" data-filter="voto" data-value="${voto}">
              <span style="color:${Utils.getRatingColor(voto)}">‚óè</span> ${voto}
            </div>
          `).join('')}
        `;

        // Add click handlers
        document.querySelectorAll('.filter-chip').forEach(chip => {
          chip.onclick = () => {
            const filter = chip.dataset.filter;
            const value = chip.dataset.value || null;

            // Update active state
            document.querySelectorAll(`[data-filter="${filter}"]`).forEach(c => {
              c.classList.remove('active');
            });
            chip.classList.add('active');

            // Update filter
            AppState.filters[filter] = value;
          };
        });
      }
    }

    // ==================== SETTINGS MANAGER ====================
    class SettingsManager {
      static async load() {
        try {
          Utils.updateSyncStatus('Caricamento impostazioni...', 'syncing');
          
          const response = await ApiService.getSettings();
          if (response.success) {
            AppState.settings = { ...AppState.settings, ...response.data };
            this.updateUI();
            Utils.updateSyncStatus('Impostazioni caricate', 'success');
          }
        } catch (error) {
          console.warn('Impossibile caricare settings:', error);
          Utils.updateSyncStatus('Errore caricamento settings', 'error');
        }
      }

      static async save() {
        try {
          const settings = {
            baseLayer: document.getElementById('mapStyleSelect').value,
            randomIncludeLowRated: document.getElementById('randomLowRatedCheckbox').checked,
            crosshairEnabled: document.getElementById('crosshairEnabled').checked
          };

          Utils.updateSyncStatus('Salvataggio impostazioni...', 'syncing');
          
          const response = await ApiService.saveSettings(settings);
          if (response.success) {
            AppState.settings = { ...AppState.settings, ...response.data };
            this.updateUI();
            
            // Update map layer if needed
            if (AppState.settings.baseLayer !== settings.baseLayer) {
              MapManager.switchLayer(settings.baseLayer);
            }
            
            Utils.updateSyncStatus('Impostazioni salvate', 'success');
            Utils.showToast('Impostazioni salvate con successo!', 'success');
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore salvataggio settings', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        }
      }

      static updateUI() {
        const mapStyleSelect = document.getElementById('mapStyleSelect');
        const randomLowRatedCheckbox = document.getElementById('randomLowRatedCheckbox');
        const crosshairEnabledCheckbox = document.getElementById('crosshairEnabled');
        const crosshairToggleBtn = document.getElementById('crosshairToggleBtn');

        if (mapStyleSelect) {
          mapStyleSelect.value = AppState.settings.baseLayer || 'osm';
        }

        if (randomLowRatedCheckbox) {
          randomLowRatedCheckbox.checked = AppState.settings.randomIncludeLowRated || false;
        }

        if (crosshairEnabledCheckbox) {
          crosshairEnabledCheckbox.checked = AppState.settings.crosshairEnabled || false;
        }

        if (crosshairToggleBtn) {
          crosshairToggleBtn.classList.toggle('active', AppState.settings.crosshairEnabled);
        }

        // Update crosshair visibility
        const crosshair = document.getElementById('crosshair');
        if (crosshair) {
          crosshair.style.display = AppState.settings.crosshairEnabled && AppState.isMobile ? 'block' : 'none';
        }
      }

      static toggleCrosshair() {
        AppState.settings.crosshairEnabled = !AppState.settings.crosshairEnabled;
        this.updateUI();
        Utils.showToast(
          AppState.settings.crosshairEnabled ? 'Mirino attivato' : 'Mirino disattivato',
          'info'
        );
      }
    }

    // ==================== DATA MANAGER ====================
    class DataManager {
      static async loadSpots() {
        try {
          AppState.pendingOperations++;
          Utils.updateSyncStatus('Caricamento spot...', 'syncing');

          const response = await ApiService.getSpots();
          if (response.success) {
            AppState.spots = response.data || [];
            
            MapManager.renderSpots();
            ListManager.render();
            ListManager.initFilters();
            
            // Update badge
            const badge = document.getElementById('spotsBadge');
            if (badge) {
              badge.textContent = AppState.spots.length;
              badge.style.display = AppState.spots.length > 0 ? 'flex' : 'none';
            }
            
            Utils.updateSyncStatus(`${AppState.spots.length} spot caricati`, 'success');
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore caricamento spot', 'error');
          Utils.showToast(`Errore caricamento spot: ${error.message}`, 'error');
        } finally {
          AppState.pendingOperations--;
        }
      }

      static async pickRandomSpot() {
        if (AppState.spots.length === 0) {
          Utils.showToast('Nessuno spot disponibile', 'warning');
          return;
        }

        let candidates = AppState.spots;
        if (!AppState.settings.randomIncludeLowRated) {
          candidates = AppState.spots.filter(spot => !spot.voto || spot.voto >= 3);
          if (candidates.length === 0) {
            candidates = AppState.spots;
          }
        }

        const randomIndex = Math.floor(Math.random() * candidates.length);
        const spot = candidates[randomIndex];
        
        AppState.currentSpot = spot;
        MapManager.centerOnSpot(spot);
        
        Utils.showToast(`Spot casuale: ${spot.name}`, 'info');
      }

      static async deleteSpot(spotId) {
        const confirmed = await Utils.confirm(
          'Eliminazione spot',
          'Sei sicuro di voler eliminare questo spot? Questa azione non pu√≤ essere annullata.'
        );

        if (!confirmed) return;

        try {
          AppState.pendingOperations++;
          Utils.updateSyncStatus('Eliminazione spot...', 'syncing');

          const response = await ApiService.deleteSpot(spotId);
          if (response.success) {
            AppState.spots = AppState.spots.filter(spot => spot.id !== spotId);
            
            MapManager.renderSpots();
            ListManager.render();
            
            Utils.updateSyncStatus('Spot eliminato', 'success');
            Utils.showToast('Spot eliminato con successo', 'success');
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore eliminazione', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        } finally {
          AppState.pendingOperations--;
        }
      }

      static async saveAllData() {
        try {
          Utils.updateSyncStatus('Salvataggio completo...', 'syncing');

          await SettingsManager.save();
          await this.loadSpots();

          Utils.updateSyncStatus('Dati salvati', 'success');
          Utils.showToast('Tutti i dati sono stati salvati', 'success');
        } catch (error) {
          Utils.updateSyncStatus('Errore salvataggio', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        }
      }
    }

    // ==================== MISSION MANAGER ====================
    class MissionManager {
      static async open() {
        if (!AppState.currentSpot) {
          Utils.showToast('Seleziona prima uno spot dalla mappa', 'warning');
          return;
        }

        const titleEl = document.getElementById('missionBodyTitle');
        const coordsEl = document.getElementById('missionBodyCoords');
        const textEl = document.getElementById('missionText');

        if (!titleEl || !coordsEl || !textEl) return;

        titleEl.textContent = AppState.currentSpot.name;
        coordsEl.textContent = `${AppState.currentSpot.lat.toFixed(6)}, ${AppState.currentSpot.lng.toFixed(6)}`;

        try {
          const response = await ApiService.getMission(AppState.currentSpot.id);
          if (response.success) {
            textEl.value = response.data || '';
          }
        } catch (error) {
          textEl.value = '';
        }

        document.getElementById('missionPanel').classList.remove('hidden');
      }

      static async save() {
        if (!AppState.currentSpot) return;

        const text = document.getElementById('missionText').value;

        try {
          Utils.updateSyncStatus('Salvataggio missione...', 'syncing');

          const response = await ApiService.saveMission(AppState.currentSpot.id, text);
          if (response.success) {
            Utils.updateSyncStatus('Missione salvata', 'success');
            Utils.showToast('Missione salvata con successo', 'success');
            
            document.getElementById('missionPanel').classList.add('hidden');
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore salvataggio', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        }
      }
    }

    // ==================== IMPORT LINK MANAGER ====================
    class ImportLinkManager {
      static async decode() {
        const urlInput = document.getElementById('linkInput');
        const resultDiv = document.getElementById('linkResult');
        const coordsEl = document.getElementById('coordsFound');

        if (!urlInput || !resultDiv || !coordsEl) return;

        const url = urlInput.value.trim();
        if (!url) {
          Utils.showToast('Incolla un link di Google Maps', 'error');
          return;
        }

        try {
          Utils.updateSyncStatus('Decodifica link...', 'syncing');

          const response = await ApiService.decodeGoogleMapsUrl(url);
          if (response.success) {
            const { lat, lng } = response.data;
            
            coordsEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            resultDiv.style.display = 'block';
            
            FormManager.updateCoordinates(lat, lng);
            
            Utils.updateSyncStatus('Coordinate estratte', 'success');
            Utils.showToast('Coordinate estratte con successo!', 'success');
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore decodifica', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        }
      }

      static async addFromLink() {
        const nameInput = document.getElementById('linkSpotName');
        const descInput = document.getElementById('linkSpotDesc');
        const latInput = document.getElementById('fieldLat');
        const lngInput = document.getElementById('fieldLng');

        if (!nameInput || !descInput || !latInput || !lngInput) return;

        const name = nameInput.value.trim();
        const desc = descInput.value.trim();
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);

        if (!name || isNaN(lat) || isNaN(lng)) {
          Utils.showToast('Compila tutti i campi obbligatori', 'error');
          return;
        }

        const formData = {
          name,
          desc,
          lat,
          lng,
          voto: null,
          tipo: Utils.getTipo(name, desc)
        };

        try {
          AppState.pendingOperations++;
          Utils.updateSyncStatus('Aggiunta spot...', 'syncing');

          const response = await ApiService.createSpot(formData);
          
          if (response.success) {
            AppState.spots.push(response.data);
            MapManager.renderSpots();
            ListManager.render();
            
            document.getElementById('importLinkPanel').classList.add('hidden');
            urlInput.value = '';
            nameInput.value = '';
            descInput.value = '';
            resultDiv.style.display = 'none';
            
            Utils.updateSyncStatus('Spot aggiunto', 'success');
            Utils.showToast('Spot aggiunto dal link!', 'success');
          }
        } catch (error) {
          Utils.updateSyncStatus('Errore aggiunta', 'error');
          Utils.showToast(`Errore: ${error.message}`, 'error');
        } finally {
          AppState.pendingOperations--;
        }
      }
    }

    // ==================== UI EVENT HANDLERS ====================
    class EventHandlers {
      static init() {
        // Loading screen
        Utils.showLoading(true);

        // Map navigation
        document.getElementById('mapNavToggle')?.addEventListener('click', () => {
          const nav = document.getElementById('mapNavigation');
          const toggle = document.getElementById('mapNavToggle');
          
          nav.classList.toggle('show');
          toggle.classList.toggle('active');
        });

        document.getElementById('prevMapBtn')?.addEventListener('click', () => {
          const layers = Object.keys(CONFIG.MAP_LAYERS);
          const currentIndex = layers.indexOf(AppState.settings.baseLayer);
          const prevIndex = (currentIndex - 1 + layers.length) % layers.length;
          MapManager.switchLayer(layers[prevIndex]);
        });

        document.getElementById('nextMapBtn')?.addEventListener('click', () => {
          const layers = Object.keys(CONFIG.MAP_LAYERS);
          const currentIndex = layers.indexOf(AppState.settings.baseLayer);
          const nextIndex = (currentIndex + 1) % layers.length;
          MapManager.switchLayer(layers[nextIndex]);
        });

        // Dock buttons
        document.getElementById('saveAllBtn')?.addEventListener('click', DataManager.saveAllData);
        document.getElementById('streetviewBtn')?.addEventListener('click', () => {
          const lat = AppState.temporaryPin.lat || MapManager.getCurrentCenter().lat;
          const lng = AppState.temporaryPin.lng || MapManager.getCurrentCenter().lng;
          window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
        });
        
        document.getElementById('filtersBtn')?.addEventListener('click', () => {
          const filtersPanel = document.getElementById('filtersPanel');
          filtersPanel.style.display = filtersPanel.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('importLinkBtn')?.addEventListener('click', () => {
          document.getElementById('importLinkPanel').classList.remove('hidden');
        });

        document.getElementById('settingsBtn')?.addEventListener('click', () => {
          document.getElementById('settingsPanel').classList.remove('hidden');
          SettingsManager.updateUI();
        });

        document.getElementById('crosshairToggleBtn')?.addEventListener('click', SettingsManager.toggleCrosshair);

        document.getElementById('btnList')?.addEventListener('click', () => {
          document.getElementById('listPanel').classList.remove('hidden');
          ListManager.render();
        });

        document.getElementById('btnAdd')?.addEventListener('click', () => {
          document.getElementById('addPanel').classList.remove('hidden');
          FormManager.useCurrentPin();
        });

        document.getElementById('btnRandom')?.addEventListener('click', DataManager.pickRandomSpot);
        document.getElementById('missionBtn')?.addEventListener('click', MissionManager.open);

        // Dock toggle
        document.getElementById('dockToggleBtn')?.addEventListener('click', () => {
          const dock = document.getElementById('rightDock');
          const isCollapsed = dock.classList.contains('collapsed');
          
          dock.classList.toggle('collapsed');
          document.getElementById('dockToggleBtn').innerHTML = isCollapsed ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
        });

        // Close buttons
        document.querySelectorAll('.icon-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.target.closest('.overlay').classList.add('hidden');
          });
        });

        // Overlay backdrop click
        document.querySelectorAll('.overlay-backdrop').forEach(backdrop => {
          backdrop.addEventListener('click', (e) => {
            if (e.target === backdrop) {
              backdrop.closest('.overlay').classList.add('hidden');
            }
          });
        });

        // Forms
        document.getElementById('addForm')?.addEventListener('submit', FormManager.handleAddSubmit);
        document.getElementById('editForm')?.addEventListener('submit', FormManager.handleEditSubmit);
        document.getElementById('btnUseCurrentPin')?.addEventListener('click', FormManager.useCurrentPin);
        document.getElementById('btnUseCurrentPinEdit')?.addEventListener('click', FormManager.useCurrentPin);

        // Settings
        document.getElementById('btnSaveAllSettings')?.addEventListener('click', SettingsManager.save);
        document.getElementById('btnDecodeLink')?.addEventListener('click', ImportLinkManager.decode);
        document.getElementById('btnAddFromLink')?.addEventListener('click', ImportLinkManager.addFromLink);
        document.getElementById('btnSaveMission')?.addEventListener('click', MissionManager.save);

        // Search with debounce
        const searchInput = document.getElementById('listSearch');
        if (searchInput) {
          searchInput.addEventListener('input', Utils.debounce(() => {
            ListManager.render();
          }, 300));
        }

        // Filters
        document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
          AppState.filters = { tipo: null, voto: null, search: '' };
          ListManager.initFilters();
          ListManager.render();
        });

        document.getElementById('applyFiltersBtn')?.addEventListener('click', () => {
          ListManager.render();
          document.getElementById('filtersPanel').style.display = 'none';
        });

        // Add from list empty state
        document.getElementById('btnAddFromList')?.addEventListener('click', () => {
          document.getElementById('listPanel').classList.add('hidden');
          document.getElementById('addPanel').classList.remove('hidden');
          FormManager.useCurrentPin();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Close modals with Escape
          if (e.key === 'Escape') {
            document.querySelectorAll('.overlay:not(.hidden)').forEach(overlay => {
              overlay.classList.add('hidden');
            });
          }

          // Map navigation with A/D
          if (e.key === 'a' || e.key === 'A') {
            const prevBtn = document.getElementById('prevMapBtn');
            if (prevBtn) prevBtn.click();
          }
          
          if (e.key === 'd' || e.key === 'D') {
            const nextBtn = document.getElementById('nextMapBtn');
            if (nextBtn) nextBtn.click();
          }
        });

        // Online/offline detection
        window.addEventListener('online', () => {
          Utils.showToast('Connessione ripristinata', 'success');
          DataManager.loadSpots();
        });

        window.addEventListener('offline', () => {
          Utils.showToast('Connessione persa - modalit√† offline', 'warning');
        });

        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').catch(error => {
              console.log('Service Worker registration failed:', error);
            });
          });
        }
      }
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      try {
        // Initialize map
        MapManager.init();

        // Load settings
        await SettingsManager.load();

        // Load spots
        await DataManager.loadSpots();

        // Initialize event handlers
        EventHandlers.init();

        // Hide loading screen
        setTimeout(() => {
          Utils.showLoading(false);
          Utils.showToast('LTU Mappa caricata ‚úì', 'success');
        }, 1000);

        // Auto-refresh every 5 minutes
        setInterval(() => {
          if (AppState.pendingOperations === 0) {
            DataManager.loadSpots();
          }
        }, 5 * 60 * 1000);

      } catch (error) {
        console.error('Initialization error:', error);
        Utils.showToast('Errore inizializzazione applicazione', 'error');
        Utils.showLoading(false);
      }
    }

    // ==================== GLOBAL FUNCTIONS ====================
    window.editSpot = async (spotId) => {
      const spot = AppState.spots.find(s => s.id === spotId);
      if (!spot) {
        Utils.showToast('Spot non trovato', 'error');
        return;
      }

      FormManager.loadSpotIntoForm(spot);
      document.getElementById('editPanel').classList.remove('hidden');
    };

    window.deleteSpot = async (spotId) => {
      await DataManager.deleteSpot(spotId);
    };

    // ==================== START APP ====================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>